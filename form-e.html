<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Form E – Student Internship – Activity Log</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  <style>
    body {
      background: #fff;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .form-card {
      padding: 1rem;
      background: transparent;
      border: none;
      box-shadow: none;
      border-radius: 0;
      max-width: none;
      width: 100%;
    }
    .section-title {
      font-size: 1.1rem;
      color: #0d6efd;
      border-left: 4px solid #0d6efd;
      padding-left: 0.75rem;
      margin-bottom: 0.5rem;
      margin-top: 2rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .form-control:focus {
      box-shadow: 0 0 0 0.2rem rgba(13,110,253,.15);
      border-color: #0d6efd;
    }
    .btn-custom {
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 8px rgba(13,110,253,0.08);
    }
    .btn-custom:hover, .btn-custom:focus {
      background: #0b5ed7 !important;
      color: #fff !important;
      box-shadow: 0 4px 16px rgba(13,110,253,0.15);
    }
    .week-row {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .signature-input {
      width: 250px;
      border-bottom: 1px solid #000;
      border-top: none;
      border-left: none;
      border-right: none;
      background: #f8fafc;
      border-radius: 0;
    }
    
    /* Date field readonly styling */
    input[readonly] {
      background-color: #e9ecef;
      opacity: 1;
      cursor: not-allowed;
    }
    
    /* Enhanced textarea styling for better editor-like appearance */
    textarea.form-control {
      min-height: 120px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    textarea.form-control:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13,110,253,.15);
    }
    
    /* CKEditor styling */
    .ck-editor {
      width: 100%;
      display: block;
    }
    
    .ck-editor__editable {
      min-height: 200px;
    }
    
    .ck-editor__editable_inline {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 12px;
    }
    
    .ck-editor__editable:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.2rem rgba(13,110,253,.15);
    }
    
    .ck-toolbar {
      border: 1px solid #dee2e6;
      border-radius: 8px 8px 0 0;
    }
    
    .ck-content {
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Week editor containers */
    .week-editor-container {
      width: 100%;
      min-height: 200px;
    }
    
    .mobile-week-editor {
      margin-bottom: 1rem;
    }

    /* Container adjustments for full page usage */
    .container-fluid {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 1rem !important;
    }
    
    /* Full width table improvements */
    .table {
      width: 100%;
      margin-bottom: 1.5rem;
      table-layout: fixed;
    }
    
    .table td {
      vertical-align: middle;
      padding: 15px;
      word-wrap: break-word;
    }
    
    .table .bg-light {
      background-color: #f8f9fa !important;
      font-weight: 600;
      width: 180px;
      white-space: nowrap;
    }

    /* Weekly activities table enhancements */
    .weekly-table {
      width: 100%;
      table-layout: fixed;
    }

    .weekly-table .week-column {
      width: 150px;
    }

    .weekly-table .tasks-column {
      width: calc(100% - 150px);
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .form-card { 
        padding: 1.5rem 1rem; 
        margin: 0.5rem;
      }
      .section-title { 
        font-size: 1rem; 
        margin-top: 1.5rem;
      }
      
      /* Hide table on mobile */
      .desktop-table {
        display: none !important;
      }
      
      /* Show mobile layout */
      .mobile-layout {
        display: block !important;
      }
      
      /* Mobile form styling */
      .mobile-field {
        margin-bottom: 1rem;
      }
      
      .mobile-field label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
      }
      
      .mobile-field .form-control {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      /* Mobile week cards */
      .mobile-week-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 3px solid #0d6efd;
      }
      
      .mobile-week-card textarea {
        min-height: 80px;
        font-size: 14px;
      }
      
      /* Mobile CKEditor adjustments */
      .mobile-week-card .ck-editor__editable {
        min-height: 120px;
        font-size: 14px;
      }
      
      .mobile-week-card .ck-toolbar {
        font-size: 12px;
      }
      
      .mobile-week-card .ck-toolbar .ck-button {
        padding: 4px 6px;
      }
      
      .mobile-week-title {
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 0.75rem;
        font-size: 1rem;
      }
      
      /* Date field responsive */
      .date-container {
        text-align: center !important;
        margin-bottom: 1rem;
      }
      
      .date-container input {
        width: 100% !important;
        max-width: 200px;
      }
      
      /* Signature fields responsive */
      .signature-container {
        text-align: center;
        margin-top: 1rem;
      }
      
      .signature-container input {
        width: 100% !important;
        max-width: 300px;
        margin-top: 0.5rem;
      }
      
      /* Mobile signature preview */
      .signature-preview {
        width: 120px;
        height: 120px;
      }
      
      /* Button adjustments */
      .btn-group-mobile {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .btn-group-mobile .btn {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
      }
    }
    
    @media (max-width: 576px) {
      .form-card { 
        padding: 1rem 0.75rem; 
        margin: 0.25rem;
      }
      
      h3 {
        font-size: 1.25rem !important;
      }
      
      .btn-group-mobile .btn {
        padding: 0.875rem;
        font-size: 1.05rem;
      }
    }
    
    /* Desktop table - hide on mobile */
    @media (min-width: 769px) {
      .mobile-layout {
        display: none !important;
      }
      
      .desktop-table {
        display: table !important;
      }
    }
    
    @media print {
      /* Hide everything initially */
      body * {
        visibility: hidden;
      }
      
      /* Set up the page */
      @page {
        margin: 0.5cm;
        size: auto;
      }
      
      /* Reset body styles */
      body {
        margin: 0;
        padding: 0;
        min-height: 0 !important;
        height: auto !important;
        background: none !important;
      }
      
      /* Show only modal content */
      #previewModal,
      #previewContent,
      #previewContent * {
        visibility: visible;
      }
      
      #previewModal {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: visible !important;
        height: auto !important;
        page-break-after: avoid !important;
      }
      
      /* Hide unnecessary elements */
      .modal-header,
      .modal-footer,
      .no-print {
        display: none !important;
      }
      
      /* Clean modal formatting */
      .modal-dialog {
        transform: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: none !important;
        height: auto !important;
      }
      
      .modal-content {
        border: none !important;
        box-shadow: none !important;
        height: auto !important;
      }
      
      .modal-body {
        padding: 1cm !important;
        height: auto !important;
        overflow: visible !important;
      }
      
      #previewContent {
        overflow: visible !important;
        height: auto !important;
        page-break-after: avoid !important;
      }
      
      /* Clean form elements for print */
      .form-control, input[type="text"], textarea {
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
      }
    }
    
    /* Large screen optimizations */
    @media (min-width: 1200px) {
      .container-fluid {
        padding: 1.5rem 2rem !important;
        max-width: none !important;
      }
      .table {
        font-size: 1rem;
      }
      .form-control {
        font-size: 1rem;
        padding: 0.75rem 1rem;
      }
      textarea.form-control {
        font-size: 1rem;
        padding: 12px 16px;
        min-height: 140px;
      }
      .ck-editor__editable {
        min-height: 220px;
      }
      h3 {
        font-size: 2rem !important;
        margin-bottom: 2rem !important;
      }
      .section-title {
        font-size: 1.25rem;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
      }
      .form-card {
        padding: 1.5rem 2rem;
      }
    }
    
    @media (min-width: 1400px) {
      .container-fluid {
        padding: 2rem 3rem !important;
        max-width: none !important;
      }
      .table {
        font-size: 1.1rem;
      }
      .table td, .table th {
        padding: 1.2rem !important;
      }
      .form-control {
        font-size: 1.1rem;
        padding: 1rem 1.25rem;
      }
      textarea.form-control {
        font-size: 1.1rem;
        padding: 16px 20px;
        min-height: 160px;
      }
      .ck-editor__editable {
        min-height: 250px;
      }
      h3 {
        font-size: 2.5rem !important;
        margin-bottom: 3rem !important;
      }
      .section-title {
        font-size: 1.5rem;
        margin-top: 3rem;
        margin-bottom: 1.5rem;
      }
      .form-card {
        padding: 2rem 3rem;
      }
    }
  </style>
</head>
<body>

<div class="container-fluid px-1 py-0">
  <div class="row justify-content-center g-0">
    <div class="col-12">
      <form id="formE">
        <div class="form-card" id="printArea">

          <h3 class="text-center text-primary mb-3 mb-md-4 fw-bold">Form E – Student Internship – Activity Log</h3>

          <p class="small mb-3 text-center text-secondary">
            The Student Intern to fill the form and submit it to the Faculty Supervisor. The Faculty Supervisors are required to carefully review and evaluate the Student Intern's activity log. Please return the form by the end of internship before 10<sup>th</sup> of September every Year.
          </p>

          <div class="text-end small mb-3 date-container">
            <label for="dateField" class="me-2">Date:</label>
            <input type="date" class="form-control d-inline-block" style="width: 180px;" name="date" id="dateField" readonly>
          </div>

          <!-- Desktop Table Layout -->
          <div class="table-responsive desktop-table">
            <table class="table table-bordered align-middle mb-4 desktop-table">
              <tbody>
                <tr>
                  <td class="bg-light w-25">Student Intern Name</td>
                  <td colspan="3"><input type="text" class="form-control" name="student_name" placeholder="Enter your name"></td>
                </tr>
                <tr>
                  <td class="bg-light w-25">Student ID</td>
                  <td><input type="text" class="form-control" name="student_id" placeholder="Student ID"></td>
                  <td class="bg-light w-25">Department</td>
                  <td><input type="text" class="form-control" name="student_dept" placeholder="Department"></td>
                </tr>
                <tr>
                  <td class="bg-light">Host Institution</td>
                  <td colspan="3"><input type="text" class="form-control" name="host_institution" placeholder="Institution name"></td>
                </tr>
                <tr>
                  <td class="bg-light">Site Supervisor</td>
                  <td colspan="3"><input type="text" class="form-control" name="site_supervisor" placeholder="Supervisor name"></td>
                </tr>
                <tr>
                  <td class="bg-light">Faculty Supervisor</td>
                  <td colspan="3"><input type="text" class="form-control" name="faculty_supervisor" placeholder="Faculty name"></td>
                </tr>
                <tr>
                  <td class="bg-light">Internship Completion Date</td>
                  <td colspan="3"><input type="date" class="form-control" name="completion_date"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile Layout -->
          <div class="mobile-layout" style="display: none;">
            <div class="mobile-field">
              <label for="mobile_student_name">Student Intern Name</label>
              <input type="text" class="form-control" name="student_name" id="mobile_student_name" placeholder="Enter your name">
            </div>
            
            <div class="mobile-field">
              <label for="mobile_student_id">Student ID</label>
              <input type="text" class="form-control" name="student_id" id="mobile_student_id" placeholder="Student ID">
            </div>
            
            <div class="mobile-field">
              <label for="mobile_student_dept">Department</label>
              <input type="text" class="form-control" name="student_dept" id="mobile_student_dept" placeholder="Department">
            </div>
            
            <div class="mobile-field">
              <label for="mobile_host_institution">Host Institution</label>
              <input type="text" class="form-control" name="host_institution" id="mobile_host_institution" placeholder="Institution name">
            </div>
            
            <div class="mobile-field">
              <label for="mobile_site_supervisor">Site Supervisor</label>
              <input type="text" class="form-control" name="site_supervisor" id="mobile_site_supervisor" placeholder="Supervisor name">
            </div>
            
            <div class="mobile-field">
              <label for="mobile_faculty_supervisor">Faculty Supervisor</label>
              <input type="text" class="form-control" name="faculty_supervisor" id="mobile_faculty_supervisor" placeholder="Faculty name">
            </div>
            
            <div class="mobile-field">
              <label for="mobile_completion_date">Internship Completion Date</label>
              <input type="date" class="form-control" name="completion_date" id="mobile_completion_date">
            </div>
          </div>

          <!-- Weekly Activities - Desktop -->
          <div class="table-responsive desktop-table">
            <table class="table table-bordered weekly-table">
              <thead>
                <tr class="week-row">
                  <th class="week-column">Weeks</th>
                  <th class="tasks-column">Tasks Performed</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="week-row">Week # 1</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week1Editor" class="week-editor" data-week="week_1"></div>
                      <textarea name="week_1" id="week_1_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 2</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week2Editor" class="week-editor" data-week="week_2"></div>
                      <textarea name="week_2" id="week_2_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 3</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week3Editor" class="week-editor" data-week="week_3"></div>
                      <textarea name="week_3" id="week_3_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 4</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week4Editor" class="week-editor" data-week="week_4"></div>
                      <textarea name="week_4" id="week_4_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 5</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week5Editor" class="week-editor" data-week="week_5"></div>
                      <textarea name="week_5" id="week_5_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 6</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week6Editor" class="week-editor" data-week="week_6"></div>
                      <textarea name="week_6" id="week_6_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 7</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week7Editor" class="week-editor" data-week="week_7"></div>
                      <textarea name="week_7" id="week_7_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td class="week-row">Week # 8</td>
                  <td>
                    <div class="week-editor-container">
                      <div id="week8Editor" class="week-editor" data-week="week_8"></div>
                      <textarea name="week_8" id="week_8_textarea" style="display:none;"></textarea>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile Weekly Activities -->
          <div class="mobile-layout" style="display: none;">
            <div class="section-title">Weekly Activities</div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 1</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek1Editor" class="week-editor" data-week="week_1_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 2</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek2Editor" class="week-editor" data-week="week_2_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 3</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek3Editor" class="week-editor" data-week="week_3_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 4</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek4Editor" class="week-editor" data-week="week_4_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 5</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek5Editor" class="week-editor" data-week="week_5_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 6</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek6Editor" class="week-editor" data-week="week_6_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 7</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek7Editor" class="week-editor" data-week="week_7_mobile"></div>
              </div>
            </div>
            
            <div class="mobile-week-card">
              <div class="mobile-week-title">Week # 8</div>
              <div class="mobile-week-editor">
                <div id="mobileWeek8Editor" class="week-editor" data-week="week_8_mobile"></div>
              </div>
            </div>
          </div>

          <!-- Agreement Section -->
          <div class="row mt-4 mb-2">
            <div class="col-md-4">
              <div class="bg-light rounded p-3 mb-3 border-start border-primary border-3">
                <h6 class="mb-2 fw-bold text-primary">Student-Intern Agreement:</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="student_agreement" id="studentAgreement" required>
                  <label class="form-check-label" for="studentAgreement">
                    I acknowledge that the information provided in this evaluation is accurate and I agree to the terms and conditions of the internship program.
                  </label>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="bg-light rounded p-3 mb-3 border-start border-primary border-3">
                <h6 class="mb-2 fw-bold text-primary">Site Supervisor Agreement:</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="site_agreement" id="siteAgreement" required>
                  <label class="form-check-label" for="siteAgreement">
                    I confirm the evaluation of the student intern and agree to supervise according to program requirements.
                  </label>
                </div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="bg-light rounded p-3 mb-3 border-start border-primary border-3">
                <h6 class="mb-2 fw-bold text-primary">Faculty Supervisor Agreement:</h6>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="faculty_agreement" id="facultyAgreement" required>
                  <label class="form-check-label" for="facultyAgreement">
                    I acknowledge the evaluation and agree to the final assessment of the student intern's performance.
                  </label>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="text-center mt-4 no-print">
          <div class="d-md-block d-none">
            <button type="button" class="btn btn-primary btn-custom me-3" id="previewBtn">
              <i class="bi bi-eye me-1"></i> Preview
            </button>
            <button type="submit" class="btn btn-outline-primary btn-custom me-3" id="submitBtn">
              <i class="bi bi-check-circle me-1"></i> Submit
            </button>
            <button type="reset" class="btn btn-outline-secondary btn-custom">
              <i class="bi bi-arrow-clockwise me-1"></i> Reset
            </button>
          </div>
          
          <div class="d-md-none btn-group-mobile">
            <button type="button" class="btn btn-primary btn-custom" id="previewBtnMobile">
              <i class="bi bi-eye me-2"></i> Preview
            </button>
            <button type="submit" class="btn btn-outline-primary btn-custom" id="submitBtnMobile">
              <i class="bi bi-check-circle me-2"></i> Submit
            </button>
            <button type="reset" class="btn btn-outline-secondary btn-custom">
              <i class="bi bi-arrow-clockwise me-2"></i> Reset
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Activity Log Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="previewContent" style="background: #f8fafc;">
        <!-- Preview content will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="printBtnModal">
          <i class="bi bi-printer me-1"></i> Print
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Preview Modal Enhancements */
#previewContent {
  padding: 2rem 1.5rem;
  background: #f8fafc;
  border-radius: 16px;
  box-shadow: 0 2px 16px rgba(0,0,0,0.07);
  font-size: 1.05rem;
  word-break: break-word;
}
#previewContent table {
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 1px 6px rgba(0,0,0,0.04);
  margin-bottom: 1.5rem;
  table-layout: fixed;
  width: 100%;
}
#previewContent th, #previewContent td {
  word-break: break-word;
  white-space: pre-line;
  vertical-align: top;
  padding: 10px 8px;
}
#previewContent .section-title {
  font-weight: 600;
  color: #0d6efd;
  font-size: 1.08rem;
  margin-top: 1.5rem;
  margin-bottom: 0.5rem;
  border-left: 4px solid #0d6efd;
  padding-left: 0.7rem;
  background: #e7f1ff;
  border-radius: 6px;
  display: inline-block;
}
#previewContent div {
  margin-bottom: 0.7rem;
}

#previewContent .section-title-preview {
  font-weight: 600;
  color: #0d6efd;
  font-size: 1.15rem;
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
  border-left: 4px solid #0d6efd;
  padding-left: 0.7rem;
  background: #e7f1ff;
  padding: 0.4rem 0.7rem;
  border-radius: 6px;
  display: inline-block;
}

/* Mobile preview styles */
@media (max-width: 768px) {
  .modal-dialog {
    margin: 0.5rem;
    max-width: none;
  }
  
  #previewContent {
    padding: 1rem;
    font-size: 0.95rem;
  }
  
  #previewContent table {
    font-size: 0.85rem;
  }
  
  #previewContent th, #previewContent td {
    padding: 6px 4px;
  }
  
  #previewContent .section-title {
    font-size: 1rem;
    margin-top: 1rem;
  }
  
  /* Mobile signature preview in modal */
  #previewContent .row .col-md-4 {
    margin-bottom: 1rem;
  }
  
  #previewContent img[alt*="signature"] {
    width: 120px !important;
    height: 120px !important;
  }
  
  #previewContent div[style*="width: 150px"] {
    width: 120px !important;
    height: 120px !important;
  }
}

.input-error {
  border-color: #dc3545 !important;
  box-shadow: 0 0 0 0.2rem rgba(220,53,69,.15) !important;
}
.error-message {
  color: #dc3545;
  font-size: 0.95em;
  margin-top: 2px;
  margin-bottom: 4px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('formE');
  const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
  
  // Store CKEditor instances
  const editorInstances = {};
  const mobileEditorInstances = {};

  // Utility: element visibility (not display:none and in the document)
  function isVisible(el) {
    if (!el) return false;
    const style = window.getComputedStyle(el);
    if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') return false;
    // Check ancestors for display:none
    let node = el;
    while (node) {
      const s = window.getComputedStyle(node);
      if (s.display === 'none' || s.visibility === 'hidden') return false;
      node = node.parentElement;
    }
    return true;
  }

  // Create editor only if element is visible and not initialized yet
  function initEditorIfVisible(selector, key, config, store, onReady) {
    const el = document.querySelector(selector);
    if (!el) return;
    if (el.dataset.editorInitialized === 'true') return;
    
    // Skip visibility check if we're in dashboard context
    const isDashboard = !!document.getElementById('sidebar');
    if (!isDashboard && !isVisible(el)) return;

    ClassicEditor
      .create(el, config)
      .then(editor => {
        store[key] = editor;
        el.dataset.editorInitialized = 'true';
        if (typeof onReady === 'function') onReady(editor, el);
      })
      .catch(error => {
        console.error('CKEditor init error for', selector, error);
      });
  }

  const desktopEditorConfig = {
    toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'outdent', 'indent', '|', 'undo', 'redo'],
    placeholder: 'Describe tasks performed this week...',
    // Make editor taller for better use of space
    initialData: '',
  };

  const mobileEditorConfig = {
    toolbar: ['bold', 'italic', 'link', 'bulletedList', 'numberedList', '|', 'undo', 'redo'],
    placeholder: 'Describe tasks performed this week...',
    // Make mobile editor appropriately sized
    initialData: '',
  };

  // Initialize editors that are currently visible (desktop or mobile)
  function initVisibleEditors() {
    for (let i = 1; i <= 8; i++) {
      // Desktop editors
      initEditorIfVisible(
        '#week' + i + 'Editor',
        'week_' + i,
        desktopEditorConfig,
        editorInstances,
        (editor) => {
          // Sync with hidden textarea
          const textarea = document.getElementById('week_' + i + '_textarea');
          if (textarea) {
            editor.model.document.on('change:data', () => {
              textarea.value = editor.getData();
            });
          }
        }
      );

      // Mobile editors
      initEditorIfVisible(
        '#mobileWeek' + i + 'Editor',
        'week_' + i + '_mobile',
        mobileEditorConfig,
        mobileEditorInstances,
        (mobileEditor) => {
          // If corresponding desktop editor exists, keep them in sync
          const desktopKey = 'week_' + i;
          const maybeDesktop = editorInstances[desktopKey];
          if (maybeDesktop) {
            // Avoid feedback loops by checking content difference
            mobileEditor.model.document.on('change:data', () => {
              if (mobileEditor.getData() !== maybeDesktop.getData()) {
                maybeDesktop.setData(mobileEditor.getData());
              }
            });
            maybeDesktop.model.document.on('change:data', () => {
              if (maybeDesktop.getData() !== mobileEditor.getData()) {
                mobileEditor.setData(maybeDesktop.getData());
              }
            });
          }
        }
      );
    }
  }

  // On load initialize only editors that are visible (prevents "not showing" on hidden elements)
  initVisibleEditors();

  // Also try initializing any newly-visible editors after layout settles
  setTimeout(initVisibleEditors, 300);
  
  // Additional initialization for dashboard context
  const isDashboard = !!document.getElementById('sidebar');
  if (isDashboard) {
    // In dashboard, force initialization after a longer delay
    setTimeout(() => {
      console.log("Dashboard context detected - force initializing editors");
      initVisibleEditors();
    }, 800);
  }

  // Re-run initialization when viewport layout switches between desktop/mobile
  const mq = window.matchMedia('(max-width: 768px)');
  if (mq.addEventListener) {
    mq.addEventListener('change', () => setTimeout(initVisibleEditors, 200));
  } else if (mq.addListener) {
    // Safari < 14
    mq.addListener(() => setTimeout(initVisibleEditors, 200));
  }

  // Set current date automatically
  const dateField = document.getElementById('dateField');
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  const currentDate = `${year}-${month}-${day}`;
  dateField.value = currentDate;

  // Signature preview function (kept if needed later)
  function previewSignature(input, previewId) {
    const file = input.files[0];
    const preview = document.getElementById(previewId);
    
    if (file) {
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file.');
        input.value = '';
        return;
      }
      
      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('File size must be less than 2MB.');
        input.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
      preview.src = '';
    }
  }

  // Make previewSignature globally accessible
  window.previewSignature = previewSignature;

  // Validation
  const requiredFields = [
    { name: 'student_name', label: 'Student Intern Name' },
    { name: 'student_id', label: 'Student ID' },
    { name: 'student_dept', label: 'Department' },
    { name: 'host_institution', label: 'Host Institution' },
    { name: 'site_supervisor', label: 'Site Supervisor' },
    { name: 'faculty_supervisor', label: 'Faculty Supervisor' },
    { name: 'completion_date', label: 'Internship Completion Date' },
    { name: 'week_1', label: 'Week 1 Activities' },
    { name: 'week_2', label: 'Week 2 Activities' },
    { name: 'week_3', label: 'Week 3 Activities' },
    { name: 'week_4', label: 'Week 4 Activities' },
    { name: 'week_5', label: 'Week 5 Activities' },
    { name: 'week_6', label: 'Week 6 Activities' },
    { name: 'week_7', label: 'Week 7 Activities' },
    { name: 'week_8', label: 'Week 8 Activities' },
    { name: 'student_agreement', label: 'Student Agreement' },
    { name: 'site_agreement', label: 'Site Supervisor Agreement' },
    { name: 'faculty_agreement', label: 'Faculty Supervisor Agreement' }
  ];

  function clearValidation() {
    form.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    form.querySelectorAll('.error-message').forEach(el => el.remove());
  }

  function showError(input, message) {
    input.classList.add('input-error');
    let error = document.createElement('div');
    error.className = 'error-message';
    error.innerText = message;
    // Ensure message attaches to a visible container
    const parent = input.closest('.week-editor-container') || input.parentElement;
    parent.appendChild(error);
  }

  function validateForm() {
    clearValidation();
    let valid = true;
    let firstInvalid = null;
    
    for (const field of requiredFields) {
      let input = form.querySelector(`[name="${field.name}"]`);
      if (!input && !field.name.startsWith('week_')) continue;
      
      if (field.name.startsWith('week_')) {
        const weekNum = field.name.split('_')[1];
        
        // Try to get editors from local instances or global instances (dashboard context)
        const desktopEditor = editorInstances[`week_${weekNum}`] || 
                             (window.formEEditorInstances && window.formEEditorInstances[`week_${weekNum}`]);
        const mobileEditor = mobileEditorInstances[`week_${weekNum}_mobile`] || 
                            (window.formEMobileEditorInstances && window.formEMobileEditorInstances[`week_${weekNum}_mobile`]);
        const anyEditor = desktopEditor || mobileEditor;
        
        if (anyEditor) {
          const content = anyEditor.getData().replace(/<[^>]*>/g, '').trim();
          if (!content) {
            // Find visible editor container for error message
            const editorElement = document.querySelector(`#week${weekNum}Editor`) || document.querySelector(`#mobileWeek${weekNum}Editor`);
            if (editorElement) {
              const container = editorElement.closest('.week-editor-container') || editorElement.parentElement;
              showError(container, `${field.label} is required.`);
              if (!firstInvalid) firstInvalid = editorElement;
              valid = false;
            }
          }
        } else if (input) {
          // Fallback to textarea value if editor not ready
          if (!input.value.trim()) {
            showError(input, `${field.label} is required.`);
            if (!firstInvalid) firstInvalid = input;
            valid = false;
          }
        }
      } else if (input && input.type === 'checkbox') {
        if (!input.checked) {
          showError(input, `${field.label} must be accepted.`);
          if (!firstInvalid) firstInvalid = input;
          valid = false;
        }
      } else if (input && !input.value.trim()) {
        showError(input, `${field.label} is required.`);
        if (!firstInvalid) firstInvalid = input;
        valid = false;
      }
    }
    
    if (firstInvalid) {
      firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
      if (firstInvalid.focus) firstInvalid.focus();
    }
    return valid;
  }

  function previewForm(e) {
    // if (!validateForm()) {
    //   e.preventDefault();
    //   e.stopPropagation();
    //   return false;
    // }
    const data = new FormData(form);
    
    // Generate weekly activities preview
    let weeklyHtml = '';
    for (let i = 1; i <= 8; i++) {
      // Try to get editors from local instances or global instances (dashboard context)
      const desktopEditor = editorInstances[`week_${i}`] || 
                           (window.formEEditorInstances && window.formEEditorInstances[`week_${i}`]);
      const mobileEditor = mobileEditorInstances[`week_${i}_mobile`] || 
                          (window.formEMobileEditorInstances && window.formEMobileEditorInstances[`week_${i}_mobile`]);
      const editor = desktopEditor || mobileEditor;
      
      let weekData = '';
      if (editor) {
        weekData = editor.getData();
      } else {
        weekData = data.get(`week_${i}`) || '';
      }
      
      // Show all weeks, even if empty (with "Not filled" for empty ones)
      const displayContent = weekData.trim() ? weekData : 'Not filled';
      weeklyHtml += `<tr><td class="fw-bold">Week # ${i}</td><td>${displayContent}</td></tr>`;
    }
    
    // Generate agreement preview HTML
    let agreementHtml = '<div class="row mt-4">';
    
    agreementHtml += '<div class="col-md-4 text-center">';
    agreementHtml += '<div><strong>Student-Intern Agreement:</strong></div>';
    const studentAgreement = form.querySelector('input[name="student_agreement"]:checked');
    agreementHtml += studentAgreement
      ? '<div class="text-success mt-2"><i class="bi bi-check-circle me-1"></i>Student has agreed to the terms and conditions</div>'
      : '<div class="text-muted mt-2"><i class="bi bi-dash-circle me-1"></i>Agreement pending</div>';
    agreementHtml += '</div>';
    
    agreementHtml += '<div class="col-md-4 text-center">';
    agreementHtml += '<div><strong>Site Supervisor Agreement:</strong></div>';
    const siteAgreement = form.querySelector('input[name="site_agreement"]:checked');
    agreementHtml += siteAgreement
      ? '<div class="text-success mt-2"><i class="bi bi-check-circle me-1"></i>Site Supervisor has agreed to the terms and conditions</div>'
      : '<div class="text-muted mt-2"><i class="bi bi-dash-circle me-1"></i>Agreement pending</div>';
    agreementHtml += '</div>';
    
    agreementHtml += '<div class="col-md-4 text-center">';
    agreementHtml += '<div><strong>Faculty Supervisor Agreement:</strong></div>';
    const facultyAgreement = form.querySelector('input[name="faculty_agreement"]:checked');
    agreementHtml += facultyAgreement
      ? '<div class="text-success mt-2"><i class="bi bi-check-circle me-1"></i>Faculty Supervisor has agreed to the terms and conditions</div>'
      : '<div class="text-muted mt-2"><i class="bi bi-dash-circle me-1"></i>Agreement pending</div>';
    agreementHtml += '</div>';
    agreementHtml += '</div>';
    
    let html = `
      <div class="text-center mb-4">
        <h3 class="text-primary fw-bold mb-3">Form E – Student Internship – Activity Log</h3>
        <p class="small text-secondary mb-0">
          The Student Intern to fill the form and submit it to the Faculty Supervisor. The Faculty Supervisors are required to carefully review and evaluate the Student Intern's activity log. Please return the form by the end of internship before 10<sup>th</sup> of September every Year.
        </p>
      </div>
      <div class="section-title-preview">Student & Internship Details</div>
      <table class="table table-bordered mb-4">
        <tbody>
          <tr><th>Date</th><td colspan="3">${data.get('date') || 'Not filled'}</td></tr>
          <tr><th>Student Intern Name</th><td colspan="3">${data.get('student_name') || 'Not filled'}</td></tr>
          <tr><th>Student ID</th><td>${data.get('student_id') || 'Not filled'}</td>
              <th>Department</th><td>${data.get('student_dept') || 'Not filled'}</td></tr>
          <tr><th>Host Institution</th><td colspan="3">${data.get('host_institution') || 'Not filled'}</td></tr>
          <tr><th>Site Supervisor</th><td colspan="3">${data.get('site_supervisor') || 'Not filled'}</td></tr>
          <tr><th>Faculty Supervisor</th><td colspan="3">${data.get('faculty_supervisor') || 'Not filled'}</td></tr>
          <tr><th>Internship Completion Date</th><td colspan="3">${data.get('completion_date') || 'Not filled'}</td></tr>
        </tbody>
      </table>
      <div class="section-title-preview">Weekly Activities</div>
      <table class="table table-bordered mb-4">
        <thead>
          <tr><th style="width: 20%;">Week</th><th>Tasks Performed</th></tr>
        </thead>
        <tbody>
          ${weeklyHtml}
        </tbody>
      </table>
      <div class="section-title-preview">Agreements</div>
      ${agreementHtml}
    `;
    document.getElementById('previewContent').innerHTML = html;
    previewModal.show();
    return true;
  }

  function submitForm(e) {
    e.preventDefault();
    
    // Sync CKEditor data to hidden textareas before validation/submit
    for (let i = 1; i <= 8; i++) {
      // Try to get editors from local instances or global instances (dashboard context)
      const desktopEditor = editorInstances[`week_${i}`] || 
                           (window.formEEditorInstances && window.formEEditorInstances[`week_${i}`]);
      const mobileEditor = mobileEditorInstances[`week_${i}_mobile`] || 
                          (window.formEMobileEditorInstances && window.formEMobileEditorInstances[`week_${i}_mobile`]);
      const editor = desktopEditor || mobileEditor;
      const textarea = document.getElementById(`week_${i}_textarea`);
      if (editor && textarea) {
        textarea.value = editor.getData();
      }
    }
    
    if (!validateForm()) return false;
    alert('Form submitted successfully!');
    
    // Reset editors (both local and global instances)
    const allEditorInstances = [
      ...Object.values(editorInstances),
      ...Object.values(mobileEditorInstances)
    ];
    if (window.formEEditorInstances) {
      allEditorInstances.push(...Object.values(window.formEEditorInstances));
    }
    if (window.formEMobileEditorInstances) {
      allEditorInstances.push(...Object.values(window.formEMobileEditorInstances));
    }
    
    allEditorInstances.forEach(editor => {
      if (editor && editor.setData) editor.setData('');
    });
    
    form.reset();
    clearValidation();
  }

  document.getElementById('previewBtn').addEventListener('click', previewForm);
  
  // Mobile button events
  document.getElementById('previewBtnMobile').addEventListener('click', previewForm);
  
  // Modal print button event listener
  document.getElementById('printBtnModal').addEventListener('click', function(e) {
    e.preventDefault();
    var previewContent = document.getElementById('previewContent');
    
    if (!previewContent || !previewContent.innerHTML.trim()) {
      alert('Preview content is empty! Please click the Preview button first.');
      return;
    }
    
    // Use the same working print logic as Form A
    const modalBackdrop = document.querySelector('.modal-backdrop');
    const modal = document.getElementById('previewModal');
    const body = document.body;
    
    // Store original styles
    const originalBodyClass = body.className;
    const originalBackdropDisplay = modalBackdrop ? modalBackdrop.style.display : '';
    const originalModalDisplay = modal.style.display;
    
    // Hide backdrop and adjust modal for printing
    if (modalBackdrop) modalBackdrop.style.display = 'none';
    modal.style.display = 'block';
    modal.style.position = 'static';
    modal.style.transform = 'none';
    body.className = originalBodyClass.replace('modal-open', '');
    
    // Print the page
    window.print();
    
    // Restore original styles after printing
    setTimeout(() => {
      if (modalBackdrop) modalBackdrop.style.display = originalBackdropDisplay;
      modal.style.display = originalModalDisplay;
      modal.style.position = '';
      modal.style.transform = '';
      body.className = originalBodyClass;
    }, 100);
  });
  
  form.addEventListener('submit', submitForm);
  
  // Sync form values between desktop and mobile layouts
  function syncFormValues() {
    const fields = [
      'student_name', 'student_id', 'student_dept', 'host_institution', 
      'site_supervisor', 'faculty_supervisor', 'completion_date'
    ];
    
    fields.forEach(fieldName => {
      const desktopInput = form.querySelector(`input[name="${fieldName}"]:not([id^="mobile_"])`);
      const mobileInput = form.querySelector(`input[id="mobile_${fieldName}"]`);
      
      if (desktopInput && mobileInput) {
        desktopInput.addEventListener('input', () => {
          mobileInput.value = desktopInput.value;
        });
        
        mobileInput.addEventListener('input', () => {
          desktopInput.value = mobileInput.value;
        });
      }
    });
  }
  
  // Initialize form sync
  syncFormValues();
  
  // Expose editor instances globally for dashboard integration
  window.formEEditorInstances = editorInstances;
  window.formEMobileEditorInstances = mobileEditorInstances;
});
</script>

</body>
</html>